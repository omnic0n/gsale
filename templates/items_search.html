<html>
{% extends "layout.html" %}
{% block content %}
<div class="content-section">
    <fieldset class="form-group">
        <legend class="border-bottom mb-4">Real-time Search</legend>
        <div class="form-group">
            <label for="searchName" class="form-control-label">Item Name</label>
            <input type="text" id="searchName" class="form-control form-control-lg" placeholder="Start typing to search...">
        </div>
        <div class="form-group">
            <label for="searchSold" class="form-control-label">Sold Status</label>
            <select id="searchSold" class="form-control form-control-lg">
                <option value="0">Available</option>
                <option value="1">Sold</option>
                <option value="">All Items</option>
            </select>
        </div>
    </fieldset>
</div>

<div id="searchResults">
    <table class="blueTable">
        <thead>
            <tr>
                <th>Name</th> 
                <th>Sold</th>
                <th>Group</th>
                <th>Net</th>
                <th>Storage</th>
                <th>eBay</th>
            </tr>
        </thead>
        <tbody id="resultsTableBody">
            <!-- Results will be populated here -->
        </tbody>
    </table>
</div>

<!-- Add eBay ID Modal -->
<div id="addEbayIdModal" class="custom-modal" style="display: none;">
    <div class="custom-modal-backdrop" onclick="closeAddEbayIdModal()"></div>
    <div class="custom-modal-dialog">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title">Add eBay Item ID</h5>
                <button type="button" class="btn-close" onclick="closeAddEbayIdModal()">
                    <span>&times;</span>
                </button>
            </div>
            <form id="addEbayIdForm" method="POST" action="/items/modify_ajax">
                <div class="custom-modal-body">
                    <input type="hidden" id="addEbayIdItemId" name="id">
                    <input type="hidden" name="return_to" value="items_search">
                    
                    <!-- Hidden fields with current item data -->
                    <input type="hidden" id="addEbayIdCurrentName" name="name">
                    <input type="hidden" id="addEbayIdCurrentGroup" name="group">
                    <input type="hidden" id="addEbayIdCurrentCategory" name="category">
                    <input type="hidden" id="addEbayIdCurrentReturned" name="returned">
                    <input type="hidden" id="addEbayIdCurrentStorage" name="storage">
                    <input type="hidden" id="addEbayIdCurrentListDate" name="list_date">
                    <input type="hidden" id="addEbayIdCurrentSaleDate" name="sale_date">
                    <input type="hidden" id="addEbayIdCurrentPrice" name="price">
                    <input type="hidden" id="addEbayIdCurrentShippingFee" name="shipping_fee">
                    
                    <div class="form-group">
                        <label for="addEbayIdItemName">Item Name</label>
                        <input type="text" class="form-control" id="addEbayIdItemName" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="addEbayIdInput">eBay Item ID</label>
                        <small class="text-muted d-block">Enter the eBay item ID (e.g., 267415513883)</small>
                        <input type="text" class="form-control" id="addEbayIdInput" name="ebay_item_id" placeholder="eBay Item ID" required>
                    </div>
                </div>
                <div class="custom-modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddEbayIdModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add eBay ID</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Custom Modal Styles - Independent Frame */
.custom-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 0, 0, 0.6);
    padding: 0;
    margin: 0;
    overflow: hidden;
}

.custom-modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 10000;
}

.custom-modal-dialog {
    position: relative;
    z-index: 10001;
    width: 80%;
    max-width: 800px;
    min-width: 600px;
    height: auto;
    max-height: 95vh;
    margin: 20px auto;
    padding: 0;
    display: flex;
    flex-direction: column;
}

.custom-modal-content {
    background: white;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    border: 2px solid #007bff;
    position: relative;
    color: black;
    width: 100%;
    height: auto;
    max-height: 95vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.custom-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    border-bottom: 2px solid #dee2e6;
    background-color: #f8f9fa;
    flex-shrink: 0;
}

.custom-modal-title {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    color: #007bff;
}

.custom-modal-body {
    padding: 20px;
    background-color: white;
    color: black;
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    display: block;
    min-height: 400px;
}

.custom-modal-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 15px;
    padding: 20px;
    border-top: 2px solid #dee2e6;
    background-color: #f8f9fa;
    flex-shrink: 0;
}

.btn-close {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    padding: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #dc3545;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.btn-close:hover {
    background-color: #f8f9fa;
    color: #c82333;
}

#editItemModal .form-control {
    background-color: white !important;
    color: black !important;
    border: 2px solid #ced4da !important;
    font-size: 16px !important;
    padding: 12px 15px !important;
    border-radius: 6px !important;
    transition: border-color 0.2s !important;
}

#editItemModal .form-control:focus {
    border-color: #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
}

#editItemModal select.form-control {
    font-size: 16px !important;
    padding: 12px 15px !important;
    line-height: 1.5 !important;
}

#editItemModal label {
    color: #495057 !important;
    font-weight: 600;
    font-size: 16px !important;
    margin-bottom: 8px !important;
    display: block;
}

#editItemModal .form-group {
    margin-bottom: 20px !important;
}

#editItemModal .btn-primary {
    background-color: #007bff !important;
    border-color: #007bff !important;
    padding: 12px 30px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    border-radius: 6px !important;
}

#editItemModal .btn-secondary {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
    padding: 12px 30px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    border-radius: 6px !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .custom-modal-dialog {
        width: 95%;
        min-width: 300px;
        height: 90%;
    }
    
    .custom-modal-body {
        grid-template-columns: 1fr;
        gap: 15px;
    }
}
</style>

<script>
let searchTimeout;

function performSearch() {
    const name = document.getElementById('searchName').value;
    const sold = document.getElementById('searchSold').value;
    
    // Clear previous timeout
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    // Set new timeout for 300ms delay
    searchTimeout = setTimeout(() => {
        fetch(`/api/items/search?name=${encodeURIComponent(name)}&sold=${encodeURIComponent(sold)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayResults(data.items);
                } else {
                    console.error('Search error:', data.message);
                    displayResults([]);
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                displayResults([]);
            });
    }, 300);
}

function displayResults(items) {
    const tbody = document.getElementById('resultsTableBody');
    tbody.innerHTML = '';
    
    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No items found</td></tr>';
        return;
    }
    
    items.forEach(item => {
        const row = document.createElement('tr');
        
        // Set background color based on sold status
        if (item.sold == 0) {
            // Available items - green background
            row.style.backgroundColor = '#e6ffe6';
        } else if (item.sold == 1) {
            // Sold items - no special background
            row.style.backgroundColor = '';
        }
        
        // Create name cell with link
        const nameCell = document.createElement('td');
        const nameLink = document.createElement('a');
        nameLink.href = `/items/describe?item=${item.id}`;
        nameLink.textContent = item.name;
        nameCell.appendChild(nameLink);
        
        // Create sold status cell
        const soldCell = document.createElement('td');
        soldCell.textContent = item.sold == 0 ? 'Available' : 'Sold';
        
        // Create group cell
        const groupCell = document.createElement('td');
        if (item.group_id == 1) {
            groupCell.textContent = 'None';
        } else if (item.group_id) {
            const groupLink = document.createElement('a');
            groupLink.href = `/groups/detail?group_id=${item.group_id}`;
            groupLink.textContent = item.group_name;
            groupCell.appendChild(groupLink);
        }
        
        // Create net cell
        const netCell = document.createElement('td');
        netCell.textContent = item.net || '-';
        
        // Create storage cell
        const storageCell = document.createElement('td');
        storageCell.textContent = item.storage || '-';
        
                // Create eBay ID cell
                const ebayIdCell = document.createElement('td');
                if (item.ebay_item_id) {
                    // Show eBay link if ID exists
                    const ebayLink = document.createElement('a');
                    ebayLink.href = `https://www.ebay.com/itm/${item.ebay_item_id}`;
                    ebayLink.target = '_blank';
                    ebayLink.className = 'btn btn-sm btn-outline-success';
                    ebayLink.innerHTML = '<i class="fas fa-external-link-alt"></i> eBay';
                    ebayIdCell.appendChild(ebayLink);
                } else {
                    // Show add button if no ID
                    const addButton = document.createElement('button');
                    addButton.type = 'button';
                    addButton.className = 'btn btn-sm btn-outline-primary add-ebay-id-btn';
                    addButton.style.minWidth = '80px';
                    addButton.textContent = 'Add eBay ID';
                    addButton.setAttribute('data-item-id', item.id);
                    addButton.setAttribute('data-item-name', item.name);
                    console.log('Created Add eBay ID button for:', item.name, 'with classes:', addButton.className);
                    ebayIdCell.appendChild(addButton);
                }
        
        // Append all cells to row
                row.appendChild(nameCell);
                row.appendChild(soldCell);
                row.appendChild(groupCell);
                row.appendChild(netCell);
                row.appendChild(storageCell);
                row.appendChild(ebayIdCell);
        
        // Append row to tbody
        tbody.appendChild(row);
    });
}

        // Add eBay ID Modal functions
        function openAddEbayIdModal(itemId, itemName) {
            console.log('Opening Add eBay ID modal for:', { itemId, itemName });
            
            // Fetch current item data to populate required fields
            console.log('Fetching item data for:', itemName);
            fetch(`/api/items/search?name=${encodeURIComponent(itemName)}&sold=`)
                .then(response => {
                    console.log('API response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('API response data:', data);
                    if (data.success && data.items.length > 0) {
                        const item = data.items.find(i => i.id === itemId);
                        console.log('Found item:', item);
                        if (item) {
                            // Set form values
                            document.getElementById('addEbayIdItemId').value = itemId;
                            document.getElementById('addEbayIdItemName').value = itemName;
                            document.getElementById('addEbayIdInput').value = '';
                            
                            // Set hidden fields with current item data
                            document.getElementById('addEbayIdCurrentName').value = item.name;
                            document.getElementById('addEbayIdCurrentGroup').value = item.group_id;
                            document.getElementById('addEbayIdCurrentCategory').value = item.category_id || '';
                            document.getElementById('addEbayIdCurrentReturned').value = item.returned || '0';
                            document.getElementById('addEbayIdCurrentStorage').value = item.storage || '';
                            document.getElementById('addEbayIdCurrentListDate').value = item.list_date || new Date().toISOString().split('T')[0];
                            document.getElementById('addEbayIdCurrentSaleDate').value = item.sale_date || '';
                            document.getElementById('addEbayIdCurrentPrice').value = item.gross_price || '';
                            document.getElementById('addEbayIdCurrentShippingFee').value = item.shipping_fee || '';
                            
                            console.log('About to show modal');
                            // Show modal
                            document.getElementById('addEbayIdModal').style.display = 'flex';
                            console.log('Modal should be visible now');
                        } else {
                            console.error('Item not found in search results');
                            alert('Item not found in search results');
                        }
                    } else {
                        console.error('No items found or API error:', data);
                        alert('No items found or API error');
                    }
                })
                .catch(error => {
                    console.error('Error fetching item data:', error);
                    alert('Error loading item data. Please try again.');
                });
        }

        function closeAddEbayIdModal() {
            document.getElementById('addEbayIdModal').style.display = 'none';
        }

// Add event listeners
document.addEventListener('DOMContentLoaded', function() {
    const nameInput = document.getElementById('searchName');
    const soldSelect = document.getElementById('searchSold');
    
    // Add input event listener for real-time search
    nameInput.addEventListener('input', performSearch);
    soldSelect.addEventListener('change', performSearch);
    
    
            // Add event listeners to add eBay ID buttons (delegated)
            document.addEventListener('click', function(e) {
                console.log('Click detected on:', e.target);
                console.log('Button classes:', e.target.classList);
                if (e.target.classList.contains('add-ebay-id-btn')) {
                    console.log('Add eBay ID button clicked!');
                    const itemId = e.target.getAttribute('data-item-id');
                    const itemName = e.target.getAttribute('data-item-name');
                    console.log('Item data:', { itemId, itemName });
                    
                    openAddEbayIdModal(itemId, itemName);
                }
            });
    
    // Handle Add eBay ID form submission
    document.getElementById('addEbayIdForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('/items/modify_ajax', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                closeAddEbayIdModal();
                // Reload search results to show updated data
                performSearch();
            } else {
                alert('Error adding eBay ID: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding eBay ID. Please try again.');
        });
    });
    
    // Perform initial search to show available items by default
    performSearch();
});
</script>
{% endblock content %}
</html>