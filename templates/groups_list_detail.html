<html>
{% extends "layout.html" %}
{% block content %}
<h4>Group Information</h4>
<table class="blueTable">
    <thead>
        <tr>
            <th>Name</th> 
            <th>Purchase Date</th>
            <th>Total Items</th>
            <th>Sold Items</th>
            <th>Modify</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>{{ group_id[0]['name'] }}</td>
            <td><a href = "/groups/list?date={{ group_id[0]['date'] }}">{{ group_id[0]['date'] }}</a></td>
            <td>{{ total_items['total'] }}</td>
            <td>{{ total_sold_items['total'] }}</td>
            <td><a href = "/groups/modify?group_id={{ group_id[0]['id'] }}">Modify Group</a></td>
        </tr>
    </tbody>
</table>
<BR>
<BR>
<h4>Monetary Information</h4>
<table class="blueTable">
    <thead>
        <tr>
            <th>Purchase</th>
            <th>Sale</th>
            <th>Average Sale</th>
            <th>Profit</th>
            <th>ROI</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>${{ group_id[0]['price'] }}</td>
            <td>${{ sold_price }}</td>
            <td>{% if total_items['total'] %}
                ${{ "%.2f"|format(sold_price/total_items['total']) }}
                {% endif %}
            </td>
            <td>${{ sold_price - group_id[0]['price'] }}</td>
            <td>{% if group_id[0]['price'] != 0 %}
                {{ ((sold_price/group_id[0]['price']) * 100)| round }}%
                {% else %}
                0
                {% endif %}
            </td>
        </tr>
    </tbody>
</table>

<br>
<table width="100%">
    <td align="left">
        <form method="POST" action="">
            {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.button(class="btn btn-outline-info") }}
        </div>
        </form>
    </td>
    <td align="right">
        <form method="POST" action="">
            {{ quicksell.hidden_tag() }}
        <div class="form-group">
            {{ quicksell.button(class="btn btn-outline-info") }}
        </div>
        </form>
    </td>
</table>
<br>
<table class="blueTable">
    <thead>
        <tr>
            <th></th>
            <th>Name</th> 
            <th>Sold Date</th>
            <th>Days to Sell</th>
            <th>Gross</th>
            <th>Net</th>
            <th>Shipping Fee</th>
            <th>Storage</th>
            <th>Edit</th>
            <th>Remove</th>
        </tr>
    </thead>
    <tbody>
        {% set ns = namespace() %}
        {% set ns.count = 1 %}
        {% for item in items %}
        <!-- Debug: {{ item }} -->
        <tr>
            <td>{{ ns.count }}</td>
            <td>
                <a href = "/items/describe?item={{ item['id'] }}&return_to=group_detail">
                    {% if item['sold'] %}<b>{{ item['name'] }}</b>
                    {% else %}{{ item['name'] }}
                    {% endif %}
                </a>
            </td>
            <td>{% if item['sold'] == 0 %}Not Sold{% else %}{{ item['sale_date'] }}{% endif %}</td>
            <td>{% if item['sold'] == 0 %}Not Sold{% else %}{{ item['days_to_sell'] }}{% endif %}</td>
            <td>{{ item['gross'] }}</td>
            <td>{{ item['net'] }}</td>
            <td>{{ item['shipping_fee'] }}</td>
            <td>{{ item['storage'] }}</td>
            <td><button type="button" class="btn btn-sm btn-outline-primary edit-item-btn" style="min-width: 60px;" 
                data-item-id="{{ item['id'] }}"
                data-item-name="{{ item['name'] }}"
                data-group-id="{{ group_id[0]['id'] }}"
                data-storage="{{ item['storage'] }}"
                data-sale-date="{{ item['sale_date'] if item['sale_date'] else '' }}"
                data-price="{{ item['gross'] if item['gross'] else '' }}"
                data-shipping-fee="{{ item['shipping_fee'] if item['shipping_fee'] else '' }}">Edit</button></td>
            <td><a href="/items/remove?id={{ item['id'] }}">remove</a></td>
        {% set ns.count = ns.count + 1 %}
        </tr>
        {% endfor %}
    </tbody>
</table>
{% if group_id[0]['image'] %}
<br>
<br>
<center>
	<div>
		<img src="{{ url_for('static', filename='uploads/' + group_id[0]['image']) }}" width=75% height=auto>
	</div>
</center>
{% endif %}

<!-- Edit Item Modal -->
<div class="modal fade" id="editItemModal" tabindex="-1" role="dialog" aria-labelledby="editItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editItemModalLabel">Edit Item</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editItemForm" method="POST" action="/items/modify_ajax">
                <div class="modal-body">
                    <input type="hidden" id="editItemId" name="id">
                    <input type="hidden" name="return_to" value="group_detail">
                    
                    <div class="form-group">
                        <label for="editItemName">Name</label>
                        <input type="text" class="form-control" id="editItemName" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemGroup">Group</label>
                        <select class="form-control" id="editItemGroup" name="group" required>
                            {% for group in groups %}
                            <option value="{{ group['id'] }}">{{ group['name'] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemCategory">Category</label>
                        <select class="form-control" id="editItemCategory" name="category" required>
                            {% for category in categories %}
                            <option value="{{ category['id'] }}">{{ category['type'] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemStorage">Storage</label>
                        <input type="text" class="form-control" id="editItemStorage" name="storage">
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemReturned">Returned</label>
                        <select class="form-control" id="editItemReturned" name="returned">
                            <option value="0">False</option>
                            <option value="1">True</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemListDate">List Date</label>
                        <input type="date" class="form-control" id="editItemListDate" name="list_date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemSaleDate">Sale Date</label>
                        <input type="date" class="form-control" id="editItemSaleDate" name="sale_date">
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemPrice">Price</label>
                        <input type="number" step="0.01" class="form-control" id="editItemPrice" name="price">
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemShippingFee">Shipping Fee</label>
                        <input type="number" step="0.01" class="form-control" id="editItemShippingFee" name="shipping_fee">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Ensure modal is properly styled
document.addEventListener('DOMContentLoaded', function() {
    // Fix modal backdrop issues
    $('#editItemModal').on('show.bs.modal', function () {
        $(this).find('.modal-content').css('background-color', 'white');
        $(this).find('.modal-content').css('color', 'black');
    });
    
    // Add event listeners to edit buttons
    document.querySelectorAll('.edit-item-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            // Get data from button attributes
            const itemId = this.getAttribute('data-item-id');
            const name = this.getAttribute('data-item-name');
            const groupId = this.getAttribute('data-group-id');
            const storage = this.getAttribute('data-storage');
            const saleDate = this.getAttribute('data-sale-date');
            const price = this.getAttribute('data-price');
            const shippingFee = this.getAttribute('data-shipping-fee');
            
            // Debug: log the data
            console.log('Item data:', { itemId, name, groupId, storage, saleDate, price, shippingFee });
            
            // Set form values
            document.getElementById('editItemId').value = itemId;
            document.getElementById('editItemName').value = name;
            document.getElementById('editItemGroup').value = groupId;
            document.getElementById('editItemStorage').value = storage || '';
            document.getElementById('editItemReturned').value = '0'; // Default to False
            document.getElementById('editItemListDate').value = new Date().toISOString().split('T')[0]; // Today's date
            document.getElementById('editItemSaleDate').value = saleDate || '';
            document.getElementById('editItemPrice').value = price || '';
            document.getElementById('editItemShippingFee').value = shippingFee || '';
            
            // Set default category (first one)
            const categorySelect = document.getElementById('editItemCategory');
            if (categorySelect.options.length > 0) {
                categorySelect.value = categorySelect.options[0].value;
            }
            
            // Show modal
            $('#editItemModal').modal('show');
        });
    });
});

// Handle form submission
document.getElementById('editItemForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/items/modify_ajax', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            alert('Item updated successfully!');
            // Close modal
            $('#editItemModal').modal('hide');
            // Reload page to show updated data
            location.reload();
        } else {
            alert('Error updating item: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating item. Please try again.');
    });
});
</script>
{% endblock content %}
</html>