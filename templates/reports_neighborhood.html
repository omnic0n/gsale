{% extends "layout.html" %}
{% block content %}
<style>
.neighborhood-link {
    color: #007bff;
    text-decoration: none;
    font-weight: bold;
}

.neighborhood-link:hover {
    color: #0056b3;
    text-decoration: underline;
}

.neighborhood-link:visited {
    color: #6f42c1;
}

.sort-link {
    color: #333;
    text-decoration: none;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
    position: relative;
}

.sort-link:hover {
    color: #007bff;
    background-color: #f8f9fa;
}

.sort-link.active {
    color: #007bff;
    background-color: #e3f2fd;
}

.sort-arrow {
    font-size: 0.8em;
    margin-left: 5px;
    opacity: 0.5;
}

.sort-link:hover .sort-arrow {
    opacity: 1;
}

.sort-link.active .sort-arrow {
    opacity: 1;
}
</style>
<script>
// Wait for page to load
setTimeout(function() {
    const stateSelect = document.getElementById('state_filter');
    const citySelect = document.getElementById('city_filter');
    
    if (!stateSelect || !citySelect) {
        return;
    }
    
    // Store cities for each state
    const citiesByState = {};
    
    // Build cities by state from template data
    {% for neighborhood in all_neighborhoods %}
    {% if neighborhood.state and neighborhood.city %}
    if (!citiesByState['{{ neighborhood.state }}']) {
        citiesByState['{{ neighborhood.state }}'] = [];
    }
    if (citiesByState['{{ neighborhood.state }}'].indexOf('{{ neighborhood.city }}') === -1) {
        citiesByState['{{ neighborhood.state }}'].push('{{ neighborhood.city }}');
    }
    {% endif %}
    {% endfor %}
    
    // Sort cities for each state
    Object.keys(citiesByState).forEach(stateKey => {
        citiesByState[stateKey].sort();
    });
    
    // Update city dropdown when state changes
    stateSelect.addEventListener('change', function() {
        const selectedState = this.value;
        
        // Clear current city options
        citySelect.innerHTML = '<option value="">All Cities</option>';
        
        // Add cities for selected state
        if (selectedState && citiesByState[selectedState]) {
            citiesByState[selectedState].forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
        }
        
        // Reset sorting when filter changes
        resetSorting();
    });
    
    // Reset sorting when city changes
    citySelect.addEventListener('change', function() {
        resetSorting();
    });
    
    // If there's a selected city from form submission, populate it
    {% if selected_city %}
    const selectedCity = '{{ selected_city }}';
    const selectedState = '{{ selected_state }}';
    if (selectedState && citiesByState[selectedState]) {
        citiesByState[selectedState].forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            if (city === selectedCity) {
                option.selected = true;
            }
            citySelect.appendChild(option);
        });
    }
    {% endif %}
    
    // Reset sorting on page load to ensure clean state
    resetSorting();
}, 1000); // Wait 1 second for page to fully load

// JavaScript table sorting function
let currentSortColumn = -1;
let currentSortDirection = 'asc';

function sortTable(columnIndex) {
    const table = document.querySelector('.blueTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Determine sort direction
    if (currentSortColumn === columnIndex) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortDirection = 'asc';
    }
    currentSortColumn = columnIndex;
    
    // Update arrow indicators
    updateSortArrows(columnIndex, currentSortDirection);
    
    // Sort rows
    rows.sort((a, b) => {
        const aValue = getCellValue(a, columnIndex);
        const bValue = getCellValue(b, columnIndex);
        
        // Handle numeric columns (3, 4, 5, 6, 7)
        if ([3, 4, 5, 6, 7].includes(columnIndex)) {
            const aNum = parseFloat(aValue.replace(/[$,]/g, '')) || 0;
            const bNum = parseFloat(bValue.replace(/[$,]/g, '')) || 0;
            
            if (currentSortDirection === 'asc') {
                return aNum - bNum;
            } else {
                return bNum - aNum;
            }
        } else {
            // Handle text columns
            if (currentSortDirection === 'asc') {
                return aValue.localeCompare(bValue);
            } else {
                return bValue.localeCompare(aValue);
            }
        }
    });
    
    // Reorder rows in DOM
    rows.forEach(row => tbody.appendChild(row));
}

function getCellValue(row, columnIndex) {
    const cell = row.cells[columnIndex];
    if (!cell) return '';
    
    // For neighborhood column, get the text content but exclude the description
    if (columnIndex === 0) {
        const link = cell.querySelector('.neighborhood-link');
        return link ? link.textContent.trim() : cell.textContent.trim();
    }
    
    return cell.textContent.trim();
}

function updateSortArrows(columnIndex, direction) {
    // Reset all arrows
    document.querySelectorAll('.sort-arrow').forEach(arrow => {
        arrow.textContent = '↕';
        arrow.style.opacity = '0.5';
    });
    
    // Update current column arrow
    const currentArrow = document.querySelectorAll('.sort-link')[columnIndex].querySelector('.sort-arrow');
    if (direction === 'asc') {
        currentArrow.textContent = '↑';
    } else {
        currentArrow.textContent = '↓';
    }
    currentArrow.style.opacity = '1';
    
    // Update active state
    document.querySelectorAll('.sort-link').forEach(link => {
        link.classList.remove('active');
    });
    document.querySelectorAll('.sort-link')[columnIndex].classList.add('active');
}

function resetSorting() {
    // Reset sort state
    currentSortColumn = -1;
    currentSortDirection = 'asc';
    
    // Reset all arrows
    document.querySelectorAll('.sort-arrow').forEach(arrow => {
        arrow.textContent = '↕';
        arrow.style.opacity = '0.5';
    });
    
    // Remove active state from all headers
    document.querySelectorAll('.sort-link').forEach(link => {
        link.classList.remove('active');
    });
}
</script>
<div class="content-wrapper">
    <h1>Neighborhood Sales Report</h1>
    <p>Analyze sales performance by neighborhood with scoring system</p>
    
    <form method="POST" class="mb-4" id="filterForm">
        <!-- Preserve current filters -->
        {% if selected_state %}
        <input type="hidden" name="state" value="{{ selected_state }}">
        {% endif %}
        {% if selected_city %}
        <input type="hidden" name="city" value="{{ selected_city }}">
        {% endif %}
        <div class="form-group">
            <div class="row">
                <div class="col-md-4">
                    <label for="state_filter">State Filter:</label>
                    <select name="state" id="state_filter" class="form-control">
                        <option value="">All States</option>
                        {% for state_code in state_choices %}
                            {% set state_names = {
                                'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
                                'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
                                'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
                                'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
                                'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
                                'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
                                'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
                                'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
                                'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
                                'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming',
                                'DC': 'District of Columbia'
                            } %}
                            <option value="{{ state_code }}">
                                {{ state_names.get(state_code, state_code) }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="city_filter">City Filter:</label>
                    <select name="city" id="city_filter" class="form-control">
                        <option value="">All Cities</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label>&nbsp;</label>
                    <div>
                        <button type="submit" class="btn btn-primary">Filter</button>
                        <a href="/reports/neighborhood" class="btn btn-secondary ml-2">Clear</a>
                    </div>
                </div>
            </div>
        </div>
    </form>
    
    {% if not neighborhoods %}
    <div class="alert alert-warning mt-3">
        <h4>No Neighborhoods Found</h4>
        <p>No neighborhoods were found. You need to create neighborhoods first in the Settings menu.</p>
        <a href="/settings/neighborhoods" class="btn btn-primary">Manage Neighborhoods</a>
    </div>
    {% else %}
    
    <div class="table-responsive">
        <table class="blueTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)" class="sort-link">Neighborhood <span class="sort-arrow">↕</span></th>
                    <th onclick="sortTable(1)" class="sort-link">City <span class="sort-arrow">↕</span></th>
                    <th onclick="sortTable(2)" class="sort-link">State <span class="sort-arrow">↕</span></th>
                    <th onclick="sortTable(3)" class="sort-link">Total Items <span class="sort-arrow">↕</span></th>
                    <th onclick="sortTable(4)" class="sort-link">Items Sold <span class="sort-arrow">↕</span></th>
                    <th onclick="sortTable(5)" class="sort-link">Total Spent <span class="sort-arrow">↕</span></th>
                    <th onclick="sortTable(6)" class="sort-link">Total Earned <span class="sort-arrow">↕</span></th>
                    <th onclick="sortTable(7)" class="sort-link">Profit <span class="sort-arrow">↕</span></th>
                </tr>
            </thead>
            <tbody>
                {% for data in neighborhoods %}
                {% set neighborhood = data.neighborhood %}
                {% set sales = data.sales_data %}
                <tr>
                    <td>
                        <a href="/reports/neighborhood/detail/{{ neighborhood.id }}" class="neighborhood-link">
                            <strong>{{ neighborhood.name }}</strong>
                        </a>
                        {% if neighborhood.description %}
                            <br><small class="text-muted">{{ neighborhood.description }}</small>
                        {% endif %}
                    </td>
                    <td>{{ neighborhood.city or 'N/A' }}</td>
                    <td>
                        {% if neighborhood.state %}
                            {% set state_names = {
                                'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
                                'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
                                'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
                                'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
                                'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
                                'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
                                'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
                                'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
                                'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
                                'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming',
                                'DC': 'District of Columbia'
                            } %}
                            {{ state_names.get(neighborhood.state, neighborhood.state) }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>{{ sales.total_items }}</td>
                    <td>{{ sales.sold_items }}</td>
                    <td>${{ "%.2f"|format(sales.total_spent) }}</td>
                    <td>${{ "%.2f"|format(sales.total_earned) }}</td>
                    <td>
                        <span class="{% if sales.profit > 0 %}text-success{% elif sales.profit < 0 %}text-danger{% endif %}">
                            ${{ "%.2f"|format(sales.profit) }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% endif %}
</div>

{% endblock content %}
