<html>
{% extends "layout.html" %}
{% block content %}
<div class="container mt-3">
    <div class="row mb-3">
        <div class="col-md-6">
            <form method="GET" action="{{ url_for('list_items') }}" class="d-flex">
                <select name="sold_status" class="form-select me-2" onchange="this.form.submit()">
                    <option value="all" {% if request.args.get('sold_status', 'all') == 'all' %}selected{% endif %}>All Items</option>
                    <option value="sold" {% if request.args.get('sold_status') == 'sold' %}selected{% endif %}>Sold Items</option>
                    <option value="not_sold" {% if request.args.get('sold_status') == 'not_sold' %}selected{% endif %}>Not Sold Items</option>
                </select>
                <!-- Preserve other URL parameters -->
                {% if request.args.get('category_id') %}
                    <input type="hidden" name="category_id" value="{{ request.args.get('category_id') }}">
                {% endif %}
                {% if request.args.get('sold_date') %}
                    <input type="hidden" name="sold_date" value="{{ request.args.get('sold_date') }}">
                {% endif %}
                {% if request.args.get('purchase_date') %}
                    <input type="hidden" name="purchase_date" value="{{ request.args.get('purchase_date') }}">
                {% endif %}
                {% if request.args.get('list_date') %}
                    <input type="hidden" name="list_date" value="{{ request.args.get('list_date') }}">
                {% endif %}
                {% if request.args.get('storage') %}
                    <input type="hidden" name="storage" value="{{ request.args.get('storage') }}">
                {% endif %}
            </form>
        </div>
    </div>
</div>

<table class="blueTable">
    <thead>
        <tr>
            <th></th>
            <th>Name</th> 
            <th>Purchase Date</th>
            <th>List Date</th>
            <th>Sold Date</th>
            <th>Days to Sell</th>
            <th>Sold Net</th>
            <th>Storage</th>
            <th>Group</th>
            <th>Edit</th> 
        </tr>
    </thead>
    <tbody>
        {% set count = namespace(value=1) %}
        {% for item in items %}
        <tr>
            <td>{{ count.value }}</td>
            <td><a href = "/items/describe?item={{ item['id'] }}">{{ item['name'] }}</a></td>
            <td><a href = "/items/list?purchase_date={{ item['purchase_date'] }}">{{ item['purchase_date'] }}</a></td>
            <td><a href = "/items/list?list_date={{ item['list_date'] }}">{{ item['list_date'] }}</a></td>
            {% if item['sold'] %}
                <td><a href = "/items/list?sold_date={{ item['sale_date'] }}&sold_status=sold">{{ item['sale_date'] }}</a></td>
                <td>{{ (item['sale_date'] - item['list_date']).days }}</td>
                <td>{{ item['net']}}</td>
            {% else %}
                <td>NA</td>
                <td>NA</td>
                <td>0</td>
            {% endif %}
            <td><a href = "/items/list?storage={{ item['storage'] }}">{{ item['storage'] }}</a></td>
            <td><a href = "/groups/detail?group_id={{ item['group_id'] }}">{{ item['group_name'] }}</a></td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-primary edit-item-btn" style="min-width: 60px;" 
                    data-item-id="{{ item['id'] }}"
                    data-item-name="{{ item['name'] }}"
                    data-group-id="{{ item['group_id'] }}"
                    data-category-id="{{ item['category_id'] if item['category_id'] else '' }}"
                    data-storage="{{ item['storage'] if item['storage'] else '' }}"
                    data-sale-date="{{ item['sale_date'] if item['sale_date'] else '' }}"
                    data-price="{{ item['net'] if item['net'] else '' }}"
                    data-shipping-fee="{{ item['shipping_fee'] if item['shipping_fee'] else '' }}">Edit</button>
                <a href= "/items/remove?id={{ item['id'] }}">remove</a>
            </td>
            </tr>
        {% set count.value = count.value + 1 %}
        {% endfor %}
    </tbody>
</table>

<!-- Custom Edit Item Modal -->
<div id="editItemModal" class="custom-modal" style="display: none;">
    <div class="custom-modal-backdrop" onclick="closeEditModal()"></div>
    <div class="custom-modal-dialog">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title">Edit Item</h5>
                <button type="button" class="btn-close" onclick="closeEditModal()">
                    <span>&times;</span>
                </button>
            </div>
            <form id="editItemForm" method="POST" action="/items/modify_ajax">
                <div class="custom-modal-body">
                    <input type="hidden" id="editItemId" name="id">
                    <input type="hidden" name="return_to" value="items_list">
                    
                    <div class="form-group">
                        <label for="editItemName">Name</label>
                        <input type="text" class="form-control" id="editItemName" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemGroup">Group</label>
                        <select class="form-control" id="editItemGroup" name="group" required>
                            {% for group in groups %}
                            <option value="{{ group['id'] }}">{{ group['name'] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemCategory">Category</label>
                        <select class="form-control" id="editItemCategory" name="category" required>
                            {% for category in categories %}
                            <option value="{{ category['id'] }}">{{ category['type'] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemStorage">Storage</label>
                        <input type="text" class="form-control" id="editItemStorage" name="storage">
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemReturned">Returned</label>
                        <select class="form-control" id="editItemReturned" name="returned">
                            <option value="0">False</option>
                            <option value="1">True</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemListDate">List Date</label>
                        <input type="date" class="form-control" id="editItemListDate" name="list_date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemSaleDate">Sale Date</label>
                        <input type="date" class="form-control" id="editItemSaleDate" name="sale_date">
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemPrice">Price</label>
                        <input type="number" step="0.01" class="form-control" id="editItemPrice" name="price">
                    </div>
                    
                    <div class="form-group">
                        <label for="editItemShippingFee">Shipping Fee</label>
                        <input type="number" step="0.01" class="form-control" id="editItemShippingFee" name="shipping_fee">
                    </div>
                </div>
                <div class="custom-modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Custom Modal Styles */
.custom-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1050;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 0, 0, 0.5);
}

.custom-modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
}

.custom-modal-dialog {
    position: relative;
    z-index: 1055;
    width: 90%;
    max-width: 600px;
    margin: 1.75rem auto;
}

.custom-modal-content {
    background: white;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    border: 1px solid #dee2e6;
    position: relative;
    color: black;
}

.custom-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    background-color: white;
}

.custom-modal-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 500;
    color: black;
}

.custom-modal-body {
    padding: 1rem;
    background-color: white;
    color: black;
}

.custom-modal-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.5rem;
    padding: 1rem;
    border-top: 1px solid #dee2e6;
    background-color: white;
}

.btn-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: black;
}

.btn-close:hover {
    opacity: 0.7;
}

.custom-modal .form-control {
    background-color: white !important;
    color: black !important;
    border: 1px solid #ced4da !important;
    font-size: 16px !important;
    padding: 8px 12px !important;
}

.custom-modal select.form-control {
    font-size: 16px !important;
    padding: 8px 12px !important;
    line-height: 1.5 !important;
}

.custom-modal label {
    color: black !important;
    font-weight: bold;
    font-size: 16px !important;
    margin-bottom: 8px !important;
}

.custom-modal .form-group {
    margin-bottom: 20px !important;
}
</style>

<script>
// Custom modal functions
function openEditModal(itemId, name, groupId, categoryId, storage, saleDate, price, shippingFee) {
    console.log('Opening modal with data:', { itemId, name, groupId, categoryId, storage, saleDate, price, shippingFee });
    
    // Set form values
    document.getElementById('editItemId').value = itemId;
    document.getElementById('editItemName').value = name;
    document.getElementById('editItemGroup').value = groupId;
    document.getElementById('editItemStorage').value = storage || '';
    document.getElementById('editItemReturned').value = '0'; // Default to False
    document.getElementById('editItemListDate').value = new Date().toISOString().split('T')[0]; // Today's date
    document.getElementById('editItemSaleDate').value = saleDate || '';
    document.getElementById('editItemPrice').value = price || '0';
    document.getElementById('editItemShippingFee').value = shippingFee || '0';
    
    // Set the correct category
    const categorySelect = document.getElementById('editItemCategory');
    if (categoryId && categorySelect) {
        categorySelect.value = categoryId;
    } else if (categorySelect.options.length > 0) {
        // Fallback to first category if no category_id provided
        categorySelect.value = categorySelect.options[0].value;
    }
    
    // Show modal
    document.getElementById('editItemModal').style.display = 'flex';
}

function closeEditModal() {
    document.getElementById('editItemModal').style.display = 'none';
}

// Add event listeners to edit buttons
document.addEventListener('DOMContentLoaded', function() {
    console.log('Setting up edit button listeners...');
    document.querySelectorAll('.edit-item-btn').forEach(function(button) {
        console.log('Found edit button:', button);
        button.addEventListener('click', function() {
            console.log('Edit button clicked!');
            // Get data from button attributes
            const itemId = this.getAttribute('data-item-id');
            const name = this.getAttribute('data-item-name');
            const groupId = this.getAttribute('data-group-id');
            const categoryId = this.getAttribute('data-category-id');
            const storage = this.getAttribute('data-storage');
            const saleDate = this.getAttribute('data-sale-date');
            const price = this.getAttribute('data-price');
            const shippingFee = this.getAttribute('data-shipping-fee');
            
            // Debug: log the data
            console.log('Item data:', { itemId, name, groupId, categoryId, storage, saleDate, price, shippingFee });
            
            // Open modal
            openEditModal(itemId, name, groupId, categoryId, storage, saleDate, price, shippingFee);
        });
    });
});

// Handle form submission
document.getElementById('editItemForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/items/modify_ajax', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            alert('Item updated successfully!');
            // Close modal
            closeEditModal();
            // Reload page to show updated data
            location.reload();
        } else {
            alert('Error updating item: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating item. Please try again.');
    });
});
</script>
{% endblock content %}
</html>