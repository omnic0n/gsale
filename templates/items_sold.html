{% extends "layout.html" %}
{% block content %}
    <div class="content-section">
        <form method="POST" action="">
            {{ form.hidden_tag() }}
            <fieldset class="form-group">
                <legend class="border-bottom mb-4">Sell Item</legend>
                <div class="form-group">
                    {{ form.id.label(class="form-control-label") }}
                    {% if form.id.errors %}
                        {{ form.id(class="form-control form-control-lg is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.id.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{ form.id(class="form-control form-control-lg") }}
                    {% endif %}
                </div>
                <div class="form-group">
                    {{ form.price.label(class="form-control-label") }}
                    {% if form.price.errors %}
                        {{ form.price(class="form-control form-control-lg is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.price.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{ form.price(class="form-control form-control-lg") }}
                    {% endif %}
                </div>
                <div class="form-group">
                    {{ form.sale_date.label(class="form-control-label") }}
                    {% if form.sale_date.errors %}
                        {{ form.sale_date(class="form-control form-control-lg is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.sale_date.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{ form.sale_date(class="form-control form-control-lg") }}
                    {% endif %}
                </div>
                <div class="form-group">
                    {{ form.shipping_fee.label(class="form-control-label") }}
                    {% if form.shipping_fee.errors %}
                        {{ form.shipping_fee(class="form-control form-control-lg is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.shipping_fee.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{ form.shipping_fee(class="form-control form-control-lg", value=0) }}
                    {% endif %}
                </div>
                
                <!-- eBay Data Status (subtle) -->
                <div id="ebay-status" class="form-group" style="display: none;">
                    <small class="text-muted" id="ebay-status-text">Loading eBay data...</small>
                </div>
                <!-- Debug: eBay order breakdown -->
                <div id="ebay-debug" class="form-group border rounded p-3 bg-light" style="display: none;">
                    <strong class="text-secondary">eBay order breakdown (debug)</strong>
                    <table class="table table-sm table-borderless mb-0 mt-2">
                        <tr><td>Order ID</td><td id="debug-order-id" class="text-end font-monospace small">—</td></tr>
                        <tr><td>Subtotal</td><td id="debug-subtotal" class="text-end">—</td></tr>
                        <tr><td>Shipping</td><td id="debug-shipping" class="text-end">—</td></tr>
                        <tr><td>Sales tax</td><td id="debug-sales-tax" class="text-end">—</td></tr>
                        <tr><td>Order total (buyer paid)</td><td id="debug-order-total" class="text-end">—</td></tr>
                        <tr class="border-top"><td><strong>Order earnings</strong></td><td id="debug-order-earnings" class="text-end fw-bold">—</td></tr>
                    </table>
                </div>
            </fieldset>
            <div class="form-group">
                {{ form.submit(class="btn btn-outline-info") }}
            </div>
        </form>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemSelect = document.getElementById('id');
    const priceInput = document.getElementById('price');
    const shippingInput = document.getElementById('shipping_fee');
    const ebayStatus = document.getElementById('ebay-status');
    const ebayStatusText = document.getElementById('ebay-status-text');
    const ebayDebug = document.getElementById('ebay-debug');
    const fmt = (v) => (v != null && v !== '' && !isNaN(Number(v))) ? '$' + Number(v).toFixed(2) : '—';
    
    // Add event listener for item selection change
    itemSelect.addEventListener('change', function() {
        const selectedItemId = this.value;
        
        if (selectedItemId) {
            // Clear existing values first
            priceInput.value = '';
            shippingInput.value = '0';
            ebayDebug.style.display = 'block';
            document.getElementById('debug-order-id').textContent = '…';
            document.getElementById('debug-subtotal').textContent = '…';
            document.getElementById('debug-shipping').textContent = '…';
            document.getElementById('debug-sales-tax').textContent = '…';
            document.getElementById('debug-order-total').textContent = '…';
            document.getElementById('debug-order-earnings').textContent = '…';
            
            // Show loading status
            ebayStatus.style.display = 'block';
            ebayStatusText.innerHTML = 'Checking eBay data...';
            
            // Fetch eBay data for the selected item
            fetch(`/api/ebay-item-data/${selectedItemId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.ebay_data) {
                        const d = data.ebay_data;
                        const netEarnings = d.net_earnings ?? d.final_price ?? '';
                        priceInput.value = netEarnings !== '' ? Number(netEarnings).toFixed(2) : '';
                        
                        // Populate debug breakdown
                        document.getElementById('debug-subtotal').textContent = fmt(d.subtotal);
                        document.getElementById('debug-shipping').textContent = fmt(d.shipping);
                        document.getElementById('debug-sales-tax').textContent = fmt(d.sales_tax);
                        document.getElementById('debug-order-total').textContent = fmt(d.order_total);
                        document.getElementById('debug-order-earnings').textContent = fmt(d.final_price ?? d.net_earnings);
                        
                        priceInput.dispatchEvent(new Event('change', { bubbles: true }));
                        ebayStatus.style.display = 'none';
                    } else {
                        priceInput.value = '';
                        document.getElementById('debug-order-id').textContent = '—';
                        document.getElementById('debug-subtotal').textContent = '—';
                        document.getElementById('debug-shipping').textContent = '—';
                        document.getElementById('debug-sales-tax').textContent = '—';
                        document.getElementById('debug-order-total').textContent = '—';
                        document.getElementById('debug-order-earnings').textContent = '—';
                        ebayStatusText.innerHTML = data.message || 'No eBay data for this item';
                        ebayStatus.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error fetching eBay data:', error);
                    priceInput.value = '';
                    ebayDebug.style.display = 'none';
                    ebayStatus.style.display = 'none';
                });
        } else {
            priceInput.value = '';
            ebayDebug.style.display = 'none';
            ebayStatus.style.display = 'none';
        }
    });
    
    // Trigger change event on page load if an item is already selected
    if (itemSelect.value) {
        itemSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock content %}