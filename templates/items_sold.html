{% extends "layout.html" %}
{% block content %}
    <div class="content-section">
        <form method="POST" action="">
            {{ form.hidden_tag() }}
            <fieldset class="form-group">
                <legend class="border-bottom mb-4">Sell Item</legend>
                <div class="form-group">
                    {{ form.id.label(class="form-control-label") }}
                    {% if form.id.errors %}
                        {{ form.id(class="form-control form-control-lg is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.id.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{ form.id(class="form-control form-control-lg") }}
                    {% endif %}
                </div>
                <div class="form-group">
                    {{ form.price.label(class="form-control-label") }}
                    {% if form.price.errors %}
                        {{ form.price(class="form-control form-control-lg is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.price.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{ form.price(class="form-control form-control-lg") }}
                    {% endif %}
                </div>
                <div class="form-group">
                    {{ form.sale_date.label(class="form-control-label") }}
                    {% if form.sale_date.errors %}
                        {{ form.sale_date(class="form-control form-control-lg is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.sale_date.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{ form.sale_date(class="form-control form-control-lg") }}
                    {% endif %}
                </div>
                <div class="form-group">
                    {{ form.shipping_fee.label(class="form-control-label") }}
                    {% if form.shipping_fee.errors %}
                        {{ form.shipping_fee(class="form-control form-control-lg is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.shipping_fee.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{ form.shipping_fee(class="form-control form-control-lg", value=0) }}
                    {% endif %}
                </div>
                
                <!-- eBay Data Status -->
                <div id="ebay-status" class="form-group" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <span id="ebay-status-text">Loading eBay data...</span>
                    </div>
                </div>
            </fieldset>
            <div class="form-group">
                {{ form.submit(class="btn btn-outline-info") }}
            </div>
        </form>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemSelect = document.getElementById('id');
    const priceInput = document.getElementById('price');
    const shippingInput = document.getElementById('shipping_fee');
    const ebayStatus = document.getElementById('ebay-status');
    const ebayStatusText = document.getElementById('ebay-status-text');
    
    // Add event listener for item selection change
    itemSelect.addEventListener('change', function() {
        const selectedItemId = this.value;
        
        if (selectedItemId) {
            // Clear existing values first
            priceInput.value = '';
            shippingInput.value = '0';
            
            // Show loading status
            ebayStatus.style.display = 'block';
            ebayStatusText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking eBay data...';
            
            // Fetch eBay data for the selected item
            fetch(`/api/ebay-item-data/${selectedItemId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('eBay data response:', data);
                    
                    if (data.success && data.ebay_data) {
                        // Prepopulate with eBay data
                        const netEarnings = data.ebay_data.net_earnings || '';
                        const shipping = data.ebay_data.shipping || '0';
                        
                        console.log('Setting values - Price:', netEarnings, 'Shipping:', shipping);
                        
                        priceInput.value = netEarnings;
                        shippingInput.value = shipping;
                        
                        // Trigger change events to ensure form validation
                        priceInput.dispatchEvent(new Event('change', { bubbles: true }));
                        shippingInput.dispatchEvent(new Event('change', { bubbles: true }));
                        
                        ebayStatusText.innerHTML = '<i class="fas fa-check-circle text-success"></i> eBay data loaded successfully!';
                        ebayStatus.className = 'form-group alert alert-success';
                    } else {
                        // No eBay data available - clear the fields
                        priceInput.value = '';
                        shippingInput.value = '0';
                        
                        ebayStatusText.innerHTML = '<i class="fas fa-info-circle text-info"></i> No eBay data found for this item.';
                        ebayStatus.className = 'form-group alert alert-info';
                    }
                })
                .catch(error => {
                    console.error('Error fetching eBay data:', error);
                    
                    // Clear fields on error
                    priceInput.value = '';
                    shippingInput.value = '0';
                    
                    ebayStatusText.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Could not fetch eBay data.';
                    ebayStatus.className = 'form-group alert alert-warning';
                });
        } else {
            // Clear fields when no item is selected
            priceInput.value = '';
            shippingInput.value = '0';
            ebayStatus.style.display = 'none';
        }
    });
    
    // Trigger change event on page load if an item is already selected
    if (itemSelect.value) {
        itemSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock content %}