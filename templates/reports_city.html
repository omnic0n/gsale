{% extends "layout.html" %}
{% block content %}
<div class="content-wrapper">
    <h1>City Purchase Report</h1>
    <p>Search for purchases made in a specific city</p>
    
    <form method="POST">
        <div class="form-group">
            {{ form.state.label(class="form-control-label") }}
            {{ form.state(class="form-control", id="state_select") }}
            {% if form.state.errors %}
                <div class="text-danger">
                    {% for error in form.state.errors %}
                        <small>{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
            <small class="form-text text-muted">Select a state to filter cities</small>
        </div>
        
        <div class="form-group">
            {{ form.city.label(class="form-control-label") }}
            {{ form.city(class="form-control", id="city_select") }}
            {% if form.city.errors %}
                <div class="text-danger">
                    {% for error in form.city.errors %}
                        <small>{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
            <small class="form-text text-muted">Select a city from your purchase history</small>
        </div>
        
        <div class="form-group">
            <label for="city_year">Year:</label>
            <select name="year" id="city_year">
                <option value="all">All Years</option>
                {% for year in form.year.choices %}
                    {% if year[0] != 'all' %}
                        <option value="{{ year[0] }}">{{ year[1] }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <br>
            <small>Select a year to filter results (defaults to all years)</small>
        </div>
        
        {{ form.submit(class="btn btn-primary") }}
    </form>
    
    {% if not form.city.choices %}
    <div class="alert alert-warning mt-3">
        <h4>No Cities Found</h4>
        <p>No cities were found in your purchase history. Make sure you have set location data for your groups when creating or modifying them.</p>
    </div>
    {% endif %}
</div>

{% if selected_year and selected_year != 'all' and not purchases %}
<div class="content-wrapper">
    <div class="alert alert-info">
        <h4>No Results for {{ city }} in {{ selected_year }}</h4>
        <p>No purchases were found for the city "{{ city }}" in the year {{ selected_year }}. Try selecting a different year or city.</p>
    </div>
</div>
{% endif %}

{% if purchases %}
<div class="content-wrapper">
    <h2>Purchases in {{ city }}{% if selected_year and selected_year != 'all' %} ({{ selected_year }}){% endif %}</h2>
    
    {% if summary %}
    <div class="alert alert-info">
        <h4>Summary for {{ city }}</h4>
        <div class="row">
            <div class="col-md-3">
                <strong>Total Purchases:</strong> {{ summary.total_purchases }}
            </div>
            <div class="col-md-3">
                <strong>Total Spent:</strong> ${{ "%.2f"|format(summary.total_spent) }}
            </div>
            <div class="col-md-3">
                <strong>Total Items:</strong> {{ summary.total_items }}
            </div>
            <div class="col-md-3">
                <strong>Items Sold:</strong> {{ summary.sold_items }}
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-3">
                <strong>Total Sales:</strong> ${{ "%.2f"|format(summary.total_sales) }}
            </div>
            <div class="col-md-3">
                <strong>Total Profit:</strong> ${{ "%.2f"|format(summary.total_profit) }}
            </div>
            <div class="col-md-3">
                <strong>First Purchase:</strong> {{ summary.first_purchase }}
            </div>
            <div class="col-md-3">
                <strong>Last Purchase:</strong> {{ summary.last_purchase }}
            </div>
        </div>
        {% if summary.total_spent > 0 %}
        <div class="row mt-2">
            <div class="col-md-12">
                <strong>ROI:</strong> {{ "%.1f"|format((summary.total_profit / summary.total_spent) * 100) }}%
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <table class="blueTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Group Name</th>
                <th>Location</th>
                <th>Purchase Price</th>
                <th>Items</th>
                <th>Sold</th>
                <th>Sales Revenue</th>
                <th>Profit</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for purchase in purchases %}
            <tr>
                <td>{{ purchase.date }}</td>
                <td>{{ purchase.name }}</td>
                <td>
                    {% if purchase.location_name %}
                        {{ purchase.location_name }}
                    {% elif purchase.location_address %}
                        {{ purchase.location_address }}
                    {% else %}
                        <em>No location data</em>
                    {% endif %}
                </td>
                <td>${{ "%.2f"|format(purchase.price) }}</td>
                <td>{{ purchase.item_count }}</td>
                <td>{{ purchase.sold_count }}</td>
                <td>${{ "%.2f"|format(purchase.total_sales) }}</td>
                <td>
                    {% if purchase.profit >= 0 %}
                        <span style="color: green;">${{ "%.2f"|format(purchase.profit) }}</span>
                    {% else %}
                        <span style="color: red;">${{ "%.2f"|format(purchase.profit) }}</span>
                    {% endif %}
                </td>
                <td>
                    <a href="/groups/detail?group_id={{ purchase.id }}" class="btn btn-sm btn-outline-primary">View Details</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if purchases|length == 0 %}
    <div class="alert alert-warning">
        <h4>No purchases found</h4>
        <p>No purchases were found for the city "{{ city }}"{% if selected_year and selected_year != 'all' %} in the year {{ selected_year }}{% endif %}. Try searching for a different city name{% if selected_year and selected_year != 'all' %} or year{% endif %} or check if the location data is properly set for your groups.</p>
    </div>
    {% endif %}
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const stateSelect = document.getElementById('state_select');
    const citySelect = document.getElementById('city_select');
    
    // Function to load cities for a given state
    function loadCitiesForState(selectedState) {
        // Clear city dropdown
        citySelect.innerHTML = '<option value="">Select a city...</option>';
        
        if (selectedState) {
            // Fetch cities for the selected state
            fetch(`/reports/api/cities-by-state/${selectedState}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Populate city dropdown with cities from the selected state
                        data.cities.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city.city_name;
                            option.textContent = `${city.city_name} (${city.purchase_count} purchases, $${parseFloat(city.total_spent).toFixed(2)})`;
                            citySelect.appendChild(option);
                        });
                    } else {
                        console.error('Error fetching cities:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        } else {
            // If no state selected, keep city dropdown empty
            // City dropdown will remain with just "Select a city..." option
        }
    }
    
    // Check if there's already a selected state when page loads
    const initialState = stateSelect.value;
    if (initialState) {
        loadCitiesForState(initialState);
    }
    
    stateSelect.addEventListener('change', function() {
        loadCitiesForState(this.value);
    });
});
</script>

{% endblock content %}
